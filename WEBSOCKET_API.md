# 🌐 iConsole+ WebSocket API

Real-time workout data streaming for external applications.

## 🚀 Quick Start

1. **Enable WebSocket** in iConsole+ Settings
2. **Generate API Key** or use existing one
3. **Connect** to `ws://localhost:8080?apiKey=YOUR_API_KEY`

## 🔐 Authentication

All WebSocket connections require an API key passed as a query parameter:

```
ws://localhost:PORT?apiKey=YOUR_API_KEY
```

**Security Notes:**

- API keys are UUIDs generated by the app
- Keep your API key secure and don't share it publicly
- Invalid API keys will be rejected immediately

## 📡 Connection

### WebSocket URL

```
ws://localhost:8080?apiKey=YOUR_API_KEY
```

### HTTP Status Endpoint

```
GET http://localhost:8080/api/status
```

### API Information

```
GET http://localhost:8080/api/info
```

## 📨 Message Types

### 1. Connection Confirmation

Sent immediately after successful connection:

```json
{
  "type": "connected",
  "message": "Successfully connected to iConsole+ data stream",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 2. Workout Data (Real-time)

Sent every second during active workout:

```json
{
  "type": "workout-data",
  "data": {
    "time": 120,
    "speed": 25.5,
    "rpm": 85,
    "distance": 1.25,
    "calories": 45,
    "heartRate": 145,
    "watt": 180,
    "resistance": 8
  },
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 3. Device Status

Sent when bike connects/disconnects:

```json
{
  "type": "device-connected",
  "deviceName": "iConsole+ Bike",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

```json
{
  "type": "device-disconnected",
  "deviceName": "iConsole+ Bike",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 4. Session Status

Sent when workout recording starts/stops:

```json
{
  "type": "session-started",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

```json
{
  "type": "session-stopped",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 5. Workout Statistics

Sent when a workout session is saved:

```json
{
  "type": "workout-statistics",
  "data": {
    "totalDistance": 5.2,
    "averageSpeed": 23.4,
    "maxSpeed": 35.8,
    "totalCalories": 250,
    "averageHeartRate": 140,
    "maxHeartRate": 165,
    "averageWatt": 150,
    "maxWatt": 220,
    "duration": 1800,
    "timestamp": "2024-01-15T11:00:00.000Z"
  },
  "timestamp": "2024-01-15T11:00:00.000Z"
}
```

### 6. AI Trainer Advice

Sent when AI trainer provides new advice:

```json
{
  "type": "ai-advice",
  "data": {
    "timestamp": "2024-01-15T10:35:00.000Z",
    "advice": "Increase cadence to 90 RPM for better efficiency",
    "action": "Speed up!",
    "oldResistance": 8,
    "newResistance": 9,
    "rideStyle": "suburban",
    "goal": "endurance",
    "workoutData": {
      "time": 300,
      "speed": 25.5,
      "rpm": 75,
      "power": 180,
      "heartRate": 145
    }
  },
  "timestamp": "2024-01-15T10:35:00.000Z"
}
```

### 7. Server Shutdown

Sent before server stops:

```json
{
  "type": "server-shutdown",
  "message": "Server is shutting down",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

## 🏗️ Data Structure

### WorkoutData Fields

| Field        | Type   | Unit    | Description                 |
| ------------ | ------ | ------- | --------------------------- |
| `time`       | number | seconds | Total workout time          |
| `speed`      | number | km/h    | Current speed               |
| `rpm`        | number | rpm     | Pedaling cadence            |
| `distance`   | number | km      | Total distance              |
| `calories`   | number | kcal    | Calories burned             |
| `heartRate`  | number | bpm     | Heart rate (0 if no sensor) |
| `watt`       | number | watts   | Power output                |
| `resistance` | number | level   | Resistance level (1-32)     |

## 💻 Client Examples

### JavaScript (Browser)

```javascript
const ws = new WebSocket("ws://localhost:8080?apiKey=YOUR_API_KEY");

ws.onmessage = function (event) {
  const message = JSON.parse(event.data);

  switch (message.type) {
    case "workout-data":
      console.log("Speed:", message.data.speed, "km/h");
      console.log("Power:", message.data.watt, "W");
      break;

    case "workout-statistics":
      console.log("Session completed!");
      console.log("Total distance:", message.data.totalDistance, "km");
      console.log("Average power:", message.data.averageWatt, "W");
      break;

    case "ai-advice":
      console.log("AI Advice:", message.data.advice);
      console.log(
        "Resistance change:",
        message.data.oldResistance,
        "→",
        message.data.newResistance
      );
      break;

    case "session-started":
      console.log("Workout session started");
      break;

    case "session-stopped":
      console.log("Workout session stopped");
      break;
  }
};
```

## 🔧 Configuration

### Default Settings

- **Port**: 8080
- **Host**: 0.0.0.0 (all interfaces)
- **Authentication**: Required (API key)

### Changing Port

1. Go to iConsole+ Settings
2. Navigate to "WebSocket Data Stream"
3. Change port number (1024-65535)
4. Save settings
5. Restart WebSocket server

## 🚨 Error Handling

### Connection Rejected

- **Cause**: Invalid or missing API key
- **Solution**: Check API key in iConsole+ settings

### Connection Lost

- **Cause**: Server stopped or network issue
- **Solution**: Implement reconnection logic in your client

### Port Already in Use

- **Cause**: Another application using the same port
- **Solution**: Change port in settings or stop conflicting application

## 📱 Mobile App Integration

For mobile apps connecting over WiFi:

1. **Find Computer IP**: Use `ipconfig` (Windows) or `ifconfig` (Mac/Linux)
2. **Update URL**: `ws://192.168.1.100:8080?apiKey=YOUR_API_KEY`
3. **Firewall**: Ensure port is open in firewall settings

## 🔍 Testing

Use the included `websocket-client-example.html` file:

1. Open file in web browser
2. Enter your API key
3. Click "Connect"
4. Start workout in iConsole+ to see live data

## 📊 Performance

- **Latency**: ~50ms local network
- **Data Rate**: ~1 message/second during workout
- **Concurrent Clients**: Unlimited (tested up to 10)
- **Memory Usage**: ~1MB per connected client

## 🛠️ Troubleshooting

### No Data Received

1. Check if bike is connected in iConsole+
2. Verify workout is active (speed > 0)
3. Confirm WebSocket server is running
